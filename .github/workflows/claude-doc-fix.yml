name: Claude Doc Fix Agent

on:
  repository_dispatch:
    types: [doc-fix-request]
  workflow_dispatch:
    inputs:
      doc_fix_json:
        description: "JSON doc fix report (paste entire object or array)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: "22"

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      fix_count: ${{ steps.set-matrix.outputs.fix_count }}
    steps:
      - name: Build doc fix matrix
        id: set-matrix
        env:
          DOC_FIXES_PAYLOAD: ${{ toJson(github.event.client_payload.doc_fixes) }}
          MANUAL_DOC_FIX: ${{ inputs.doc_fix_json }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            FIXES="$DOC_FIXES_PAYLOAD"
          else
            # Manual input: wrap single object in array if needed
            if echo "$MANUAL_DOC_FIX" | jq -e 'type == "array"' > /dev/null 2>&1; then
              FIXES="$MANUAL_DOC_FIX"
            else
              FIXES=$(echo "$MANUAL_DOC_FIX" | jq -c '[.]')
            fi
          fi

          # Count fixes
          FIX_COUNT=$(echo "$FIXES" | jq 'length')
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT

          if [ "$FIX_COUNT" -eq 0 ]; then
            echo "No doc fixes to process"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build matrix with index for each fix
          MATRIX=$(echo "$FIXES" | jq -c '{include: [to_entries[] | {index: .key, fix: .value}]}')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Processing $FIX_COUNT doc fix(es)"

  fix-docs:
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.fix_count != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract doc fix report
        id: doc_fix
        env:
          FIX_JSON: ${{ toJson(matrix.fix) }}
          FIX_INDEX: ${{ matrix.index }}
        run: |
          echo "$FIX_JSON" > /tmp/doc-fix-report.json

          TITLE=$(echo "$FIX_JSON" | jq -r '.title // "unknown-fix"' | tr -cd '[:alnum:]-' | head -c 40)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="docs-fix/${TIMESTAMP}-${FIX_INDEX}-${TITLE}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "fix_title=$TITLE" >> $GITHUB_OUTPUT
          echo "Processing doc fix $FIX_INDEX: $TITLE"

      - name: Check for existing PR
        id: check_existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_TITLE: ${{ steps.doc_fix.outputs.fix_title }}
        run: |
          EXISTING_PR=$(gh pr list --state open --search "[Auto-Doc-Fix] $FIX_TITLE" --json number --jq 'length')

          if [ "$EXISTING_PR" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: PR already exists for this doc fix"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create fix branch
        if: steps.check_existing.outputs.skip != 'true'
        env:
          BRANCH_NAME: ${{ steps.doc_fix.outputs.branch_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"

      - name: Generate fix prompt
        if: steps.check_existing.outputs.skip != 'true'
        run: |
          FIX_REPORT=$(cat /tmp/doc-fix-report.json)

          cat << 'PROMPT_HEADER' > /tmp/doc-fix-prompt.md
          # Documentation Fix Agent

          You are an autonomous documentation-fixing agent for the Vurvey documentation site (VitePress/Markdown).

          ## Your Mission

          Fix the documentation issue described below. Make minimal, targeted changes to the specified file.

          ## Documentation Fix Report

          ```json
          PROMPT_HEADER

          echo "$FIX_REPORT" >> /tmp/doc-fix-prompt.md

          cat << 'PROMPT_FOOTER' >> /tmp/doc-fix-prompt.md
          ```

          ## Instructions

          1. **Understand the fix** - Read the title, description, and compare `current_text` vs `correct_text`
          2. **Locate the file** - Open the `documentation_file` and find the `section` mentioned
          3. **Apply the change** - Replace the incorrect text with the correct text
          4. **Verify context** - Make sure surrounding content still reads naturally
          5. **Check links** - If the fix involves links or references, verify they are valid

          ## Guidelines

          - Make ONLY the changes needed to fix this specific documentation issue
          - Preserve existing formatting and style (Markdown, VitePress conventions)
          - Keep the `/vurvey-docs/` base path prefix for absolute asset paths
          - Use `?optional=1` query param on screenshot references if needed
          - Don't restructure or rewrite sections beyond the identified fix
          - Don't change file names or move content unless the fix specifically requires it
          - If `qa_failure` data is provided, ensure the fix addresses the test failure

          ## VitePress Conventions

          - Documentation lives in `docs/guide/*.md`
          - Screenshots under `docs/public/screenshots/{section}/*.png`
          - Sidebar config in `docs/.vitepress/config.js`
          - All absolute paths need `/vurvey-docs/` prefix

          ## When Done

          Create a file `DOC_FIX_SUMMARY.md` with:
          - What was changed
          - Why it fixes the issue
          - Which file and section were modified

          Start fixing now.
          PROMPT_FOOTER

      - name: Run Claude Code to fix docs
        if: steps.check_existing.outputs.skip != 'true'
        id: claude_fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running Claude Code to fix documentation..."

          PROMPT_CONTENT=$(cat /tmp/doc-fix-prompt.md)

          set +e
          claude -p "$PROMPT_CONTENT" \
            --dangerously-skip-permissions \
            --max-turns 15 \
            --output-format json \
            2>&1 | tee /tmp/claude-fix-log.txt
          CLAUDE_EXIT=$?
          set -e

          if [ -f /tmp/claude-fix-log.txt ]; then
            if grep -qi "error\|failed\|unable to" /tmp/claude-fix-log.txt | head -5; then
              echo "claude_status=warning" >> $GITHUB_OUTPUT
            else
              echo "claude_status=success" >> $GITHUB_OUTPUT
            fi

            COST=$(grep -o '"total_cost":[0-9.]*' /tmp/claude-fix-log.txt | head -1 | cut -d':' -f2 || echo "unknown")
            echo "cost=$COST" >> $GITHUB_OUTPUT
          fi

          echo "Claude Code exit code: $CLAUDE_EXIT"

      - name: Validate docs
        if: steps.check_existing.outputs.skip != 'true'
        id: validate
        run: |
          echo "Validating documentation..."

          # Run docs lint (non-blocking)
          npm run lint:docs 2>&1 | tee /tmp/lint-log.txt || {
            echo "lint_passed=false" >> $GITHUB_OUTPUT
            echo "Docs lint had warnings/errors (non-blocking)"
            exit 0
          }
          echo "lint_passed=true" >> $GITHUB_OUTPUT

      - name: Check for changes
        if: steps.check_existing.outputs.skip != 'true'
        id: check_changes
        run: |
          git add -A
          git reset -- /tmp/ 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes made"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --staged --stat
          fi

      - name: Commit and push changes
        if: steps.check_existing.outputs.skip != 'true' && steps.check_changes.outputs.changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.doc_fix.outputs.branch_name }}
          WORKFLOW_RUN_ID: ${{ github.event.client_payload.workflow_run_id }}
          FIX_INDEX: ${{ matrix.index }}
        run: |
          FIX_TITLE=$(cat /tmp/doc-fix-report.json | jq -r '.title // "Documentation fix"')

          git commit -m "docs: $FIX_TITLE

          Automated fix generated by Claude Doc Fix Agent.

          Source: ${SOURCE:-qa-pipeline}
          Workflow run: ${WORKFLOW_RUN_ID:-manual}
          Fix index: $FIX_INDEX"

          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.check_existing.outputs.skip != 'true' && steps.check_changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.doc_fix.outputs.branch_name }}
          LINT_STATUS: ${{ steps.validate.outputs.lint_passed }}
        run: |
          FIX_REPORT=$(cat /tmp/doc-fix-report.json)
          FIX_TITLE=$(echo "$FIX_REPORT" | jq -r '.title // "Documentation fix"')
          DOC_FILE=$(echo "$FIX_REPORT" | jq -r '.documentation_file // "unknown"')
          SECTION=$(echo "$FIX_REPORT" | jq -r '.section // "unknown"')
          SOURCE=$(echo "$FIX_REPORT" | jq -r '.source // "unknown"')

          # Build validation status
          if [ "$LINT_STATUS" = "true" ]; then
            VALIDATION_NOTE="Docs lint: Passed"
          elif [ "$LINT_STATUS" = "false" ]; then
            VALIDATION_NOTE="Docs lint: Warnings detected - review recommended"
          else
            VALIDATION_NOTE="Docs lint: Skipped"
          fi

          cat << EOF > /tmp/pr-body.md
          ## Automated Documentation Fix

          This PR was automatically generated by the Claude Doc Fix Agent.

          ### Fix Details

          - **File:** \`$DOC_FILE\`
          - **Section:** $SECTION
          - **Source:** $SOURCE

          ### Fix Report

          \`\`\`json
          $FIX_REPORT
          \`\`\`

          ### Validation

          - $VALIDATION_NOTE

          ### Verification Checklist

          - [ ] Documentation change is accurate
          - [ ] Formatting and links are correct
          - [ ] Content reads naturally in context
          - [ ] No unintended side effects

          ---
          *Generated by Claude Doc Fix Agent*
          EOF

          gh pr create \
            --title "[Auto-Doc-Fix] $FIX_TITLE" \
            --body "$(cat /tmp/pr-body.md)" \
            --head "$BRANCH_NAME" \
            --label "documentation" \
            --label "automated" \
            --label "needs-review"

      - name: Log if no changes
        if: steps.check_existing.outputs.skip != 'true' && steps.check_changes.outputs.changes != 'true'
        run: |
          echo "No documentation changes were made for this fix."
          echo "The doc fix agent did not produce any file modifications."
          echo "This may require manual investigation."

      - name: Upload fix log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-fix-log-${{ matrix.index }}
          path: |
            /tmp/claude-fix-log.txt
            /tmp/lint-log.txt
            /tmp/doc-fix-report.json
          retention-days: 7

  summarize:
    needs: [prepare-matrix, fix-docs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        env:
          FIX_COUNT: ${{ needs.prepare-matrix.outputs.fix_count }}
          SOURCE: ${{ github.event.client_payload.source }}
          FIX_RESULT: ${{ needs.fix-docs.result }}
        run: |
          echo "## Doc Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** ${SOURCE:-manual}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fixes processed:** ${FIX_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** ${FIX_RESULT}" >> $GITHUB_STEP_SUMMARY
