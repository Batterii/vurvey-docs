name: Claude Doc Fix Agent

on:
  repository_dispatch:
    types: [doc-fix-request]
  workflow_dispatch:
    inputs:
      doc_fix_json:
        description: "JSON doc fix report (paste entire object or array)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: "22"

jobs:
  fix-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Parse doc fixes
        id: parse_fixes
        env:
          DOC_FIXES_PAYLOAD: ${{ toJson(github.event.client_payload.doc_fixes) }}
          MANUAL_DOC_FIX: ${{ inputs.doc_fix_json }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            FIXES="$DOC_FIXES_PAYLOAD"
          else
            # Manual input: wrap single object in array if needed
            if echo "$MANUAL_DOC_FIX" | jq -e 'type == "array"' > /dev/null 2>&1; then
              FIXES="$MANUAL_DOC_FIX"
            else
              FIXES=$(echo "$MANUAL_DOC_FIX" | jq -c '[.]')
            fi
          fi

          FIX_COUNT=$(echo "$FIXES" | jq 'length')
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT

          if [ "$FIX_COUNT" -eq 0 ]; then
            echo "No doc fixes to process"
            exit 0
          fi

          # Write fixes to file for later steps
          echo "$FIXES" > /tmp/all-doc-fixes.json
          echo "Processing $FIX_COUNT doc fix(es) in a single batch"

      - name: Check for existing automated PR
        if: steps.parse_fixes.outputs.fix_count != '0'
        id: check_existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for ANY open automated doc fix or nightly PR
          EXISTING_AUTO=$(gh pr list --state open --search "[Auto-Doc-Fix]" --json number,headRefName --jq '.[0]')
          EXISTING_NIGHTLY=$(gh pr list --state open --search "[Automated] Nightly" --json number,headRefName --jq '.[0]')
          EXISTING_QA=$(gh pr list --state open --search "[QA Remediation]" --json number,headRefName --jq '.[0]')

          if [ -n "$EXISTING_AUTO" ] && [ "$EXISTING_AUTO" != "null" ]; then
            EXISTING_BRANCH=$(echo "$EXISTING_AUTO" | jq -r '.headRefName')
            EXISTING_PR_NUM=$(echo "$EXISTING_AUTO" | jq -r '.number')
            echo "Found existing Auto-Doc-Fix PR #$EXISTING_PR_NUM on branch $EXISTING_BRANCH"
            echo "existing_branch=$EXISTING_BRANCH" >> $GITHUB_OUTPUT
            echo "existing_pr=$EXISTING_PR_NUM" >> $GITHUB_OUTPUT
            echo "has_existing=true" >> $GITHUB_OUTPUT
          elif [ -n "$EXISTING_NIGHTLY" ] && [ "$EXISTING_NIGHTLY" != "null" ]; then
            echo "Nightly PR already open — doc fixes are likely already included. Skipping."
            echo "has_existing=skip" >> $GITHUB_OUTPUT
          elif [ -n "$EXISTING_QA" ] && [ "$EXISTING_QA" != "null" ]; then
            echo "QA Remediation PR already open — doc fixes are likely already included. Skipping."
            echo "has_existing=skip" >> $GITHUB_OUTPUT
          else
            echo "No existing automated PR found, will create new one"
            echo "has_existing=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or checkout fix branch
        if: steps.parse_fixes.outputs.fix_count != '0' && steps.check_existing.outputs.has_existing != 'skip'
        id: branch
        env:
          HAS_EXISTING: ${{ steps.check_existing.outputs.has_existing }}
          EXISTING_BRANCH: ${{ steps.check_existing.outputs.existing_branch }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "$HAS_EXISTING" = "true" ] && [ -n "$EXISTING_BRANCH" ]; then
            echo "Pushing to existing branch: $EXISTING_BRANCH"
            git fetch origin "$EXISTING_BRANCH"
            git checkout "$EXISTING_BRANCH"
            echo "branch_name=$EXISTING_BRANCH" >> $GITHUB_OUTPUT
          else
            TIMESTAMP=$(date +%Y%m%d)
            BRANCH_NAME="automated/doc-fixes-${TIMESTAMP}"
            echo "Creating new branch: $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Apply all doc fixes via Claude Code
        if: steps.parse_fixes.outputs.fix_count != '0' && steps.check_existing.outputs.has_existing != 'skip'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FIX_COUNT: ${{ steps.parse_fixes.outputs.fix_count }}
        run: |
          echo "Processing $FIX_COUNT doc fix(es) sequentially..."

          APPLIED=0
          SKIPPED=0
          ERRORS=0

          for i in $(seq 0 $(($FIX_COUNT - 1))); do
            echo ""
            echo "=========================================="
            echo "Processing fix $((i+1)) of $FIX_COUNT"
            echo "=========================================="

            FIX=$(jq -c ".[$i]" /tmp/all-doc-fixes.json)
            TITLE=$(echo "$FIX" | jq -r '.title // "Documentation fix"')
            echo "Title: $TITLE"

            echo "$FIX" > /tmp/current-fix.json

            cat << 'PROMPT_HEADER' > /tmp/doc-fix-prompt.md
          # Documentation Fix Agent

          You are an autonomous documentation-fixing agent for the Vurvey documentation site (VitePress/Markdown).

          ## Your Mission

          Fix the documentation issue described below. Make minimal, targeted changes to the specified file.

          ## Documentation Fix Report

          ```json
          PROMPT_HEADER

            echo "$FIX" >> /tmp/doc-fix-prompt.md

            cat << 'PROMPT_FOOTER' >> /tmp/doc-fix-prompt.md
          ```

          ## Instructions

          1. **Understand the fix** - Read the title, description, and compare `current_text` vs `correct_text`
          2. **Locate the file** - Open the `documentation_file` and find the `section` mentioned
          3. **Apply the change** - Replace the incorrect text with the correct text
          4. **Verify context** - Make sure surrounding content still reads naturally
          5. **Check links** - If the fix involves links or references, verify they are valid

          ## Guidelines

          - Make ONLY the changes needed to fix this specific documentation issue
          - Preserve existing formatting and style (Markdown, VitePress conventions)
          - Use `/screenshots/...` paths (NOT `/vurvey-docs/screenshots/...`) for assets
          - Use `?optional=1` query param on screenshot references if needed
          - Don't restructure or rewrite sections beyond the identified fix
          - Don't change file names or move content unless the fix specifically requires it

          ## VitePress Conventions

          - Documentation lives in `docs/guide/*.md`
          - Screenshots under `docs/public/screenshots/{section}/*.png`
          - Sidebar config in `docs/.vitepress/config.js`

          Start fixing now.
          PROMPT_FOOTER

            set +e
            claude -p "$(cat /tmp/doc-fix-prompt.md)" \
              --model claude-sonnet-4-5-20250929 \
              --dangerously-skip-permissions \
              --max-turns 15 \
              --output-format json \
              2>&1 | tee /tmp/claude-fix-log-$i.txt
            CLAUDE_EXIT=$?
            set -e

            if [ $CLAUDE_EXIT -eq 0 ]; then
              APPLIED=$((APPLIED + 1))
              echo "Fix $((i+1)) applied successfully"

              # Stage and commit this individual fix
              git add -A
              git reset -- /tmp/ 2>/dev/null || true

              if ! git diff --staged --quiet; then
                git commit -m "docs: $TITLE

          Automated fix generated by Claude Doc Fix Agent.
          Source: ${SOURCE:-qa-pipeline}
          Fix index: $i"
              else
                echo "No file changes for fix $((i+1)), skipping commit"
                SKIPPED=$((SKIPPED + 1))
              fi
            else
              ERRORS=$((ERRORS + 1))
              echo "Fix $((i+1)) had errors (exit code: $CLAUDE_EXIT)"
            fi
          done

          echo ""
          echo "=========================================="
          echo "Batch complete: $APPLIED applied, $SKIPPED skipped, $ERRORS errors"
          echo "=========================================="
          echo "applied=$APPLIED" >> $GITHUB_ENV
          echo "skipped=$SKIPPED" >> $GITHUB_ENV
          echo "errors=$ERRORS" >> $GITHUB_ENV

      - name: Validate docs
        if: steps.parse_fixes.outputs.fix_count != '0' && steps.check_existing.outputs.has_existing != 'skip'
        id: validate
        run: |
          echo "Validating documentation..."
          npm run lint:docs 2>&1 | tee /tmp/lint-log.txt || {
            echo "lint_passed=false" >> $GITHUB_OUTPUT
            echo "Docs lint had warnings/errors (non-blocking)"
            exit 0
          }
          echo "lint_passed=true" >> $GITHUB_OUTPUT

      - name: Check for changes
        if: steps.parse_fixes.outputs.fix_count != '0' && steps.check_existing.outputs.has_existing != 'skip'
        id: check_changes
        run: |
          # Check if we have any commits beyond what's on main
          COMMIT_COUNT=$(git rev-list --count main..HEAD 2>/dev/null || echo "0")
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "$COMMIT_COUNT commit(s) ready to push"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes made"
          fi

      - name: Push changes
        if: steps.check_changes.outputs.changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: git push origin "$BRANCH_NAME"

      - name: Create or update Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
          HAS_EXISTING: ${{ steps.check_existing.outputs.has_existing }}
          EXISTING_PR: ${{ steps.check_existing.outputs.existing_pr }}
          LINT_STATUS: ${{ steps.validate.outputs.lint_passed }}
          FIX_COUNT: ${{ steps.parse_fixes.outputs.fix_count }}
          WORKFLOW_RUN_ID: ${{ github.event.client_payload.workflow_run_id }}
        run: |
          # Build fix summary from all fixes
          FIX_SUMMARY=""
          for i in $(seq 0 $(($FIX_COUNT - 1))); do
            TITLE=$(jq -r ".[$i].title // \"Fix $((i+1))\"" /tmp/all-doc-fixes.json)
            DOC_FILE=$(jq -r ".[$i].documentation_file // \"unknown\"" /tmp/all-doc-fixes.json)
            FIX_SUMMARY="${FIX_SUMMARY}- **${TITLE}** (\`${DOC_FILE}\`)
          "
          done

          # Build validation status
          if [ "$LINT_STATUS" = "true" ]; then
            VALIDATION_NOTE="Docs lint: Passed"
          elif [ "$LINT_STATUS" = "false" ]; then
            VALIDATION_NOTE="Docs lint: Warnings detected - review recommended"
          else
            VALIDATION_NOTE="Docs lint: Skipped"
          fi

          cat << EOF > /tmp/pr-body.md
          ## Automated Documentation Fixes

          This PR was automatically generated by the Claude Doc Fix Agent.
          All fixes are batched into this single PR for easier review.

          ### Fixes Included ($FIX_COUNT total)

          $FIX_SUMMARY

          ### Stats

          - **Applied:** ${applied:-0}
          - **Skipped (no changes):** ${skipped:-0}
          - **Errors:** ${errors:-0}
          - **Source workflow run:** ${WORKFLOW_RUN_ID:-manual}

          ### Validation

          - $VALIDATION_NOTE

          ### Verification Checklist

          - [ ] Documentation changes are accurate
          - [ ] Formatting and links are correct
          - [ ] Content reads naturally in context
          - [ ] No unintended side effects

          ---
          *Generated by Claude Doc Fix Agent*
          EOF

          if [ "$HAS_EXISTING" = "true" ] && [ -n "$EXISTING_PR" ]; then
            # Update existing PR body
            echo "Updating existing PR #$EXISTING_PR"
            gh pr edit "$EXISTING_PR" --body "$(cat /tmp/pr-body.md)"
          else
            # Create new PR
            gh pr create \
              --title "[Auto-Doc-Fix] Batched documentation fixes" \
              --body "$(cat /tmp/pr-body.md)" \
              --head "$BRANCH_NAME" \
              --label "documentation" \
              --label "automated" \
              --label "needs-review"
          fi

      - name: Log if skipped
        if: steps.check_existing.outputs.has_existing == 'skip'
        run: |
          echo "Skipped processing: An automated nightly or QA remediation PR is already open."
          echo "Doc fixes are likely already included in that PR."

      - name: Log if no changes
        if: steps.parse_fixes.outputs.fix_count != '0' && steps.check_existing.outputs.has_existing != 'skip' && steps.check_changes.outputs.changes != 'true'
        run: |
          echo "No documentation changes were made for any of the fixes."
          echo "This may require manual investigation."

      - name: Upload fix logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-fix-logs
          path: |
            /tmp/claude-fix-log-*.txt
            /tmp/lint-log.txt
            /tmp/all-doc-fixes.json
          retention-days: 7
