name: Nightly Documentation Sync

on:
  schedule:
    # Run every night at 3 AM UTC (10 PM EST / 11 PM EDT)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      skip_screenshots:
        description: 'Skip screenshot capture (faster for testing)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22'
  VURVEY_URL: 'https://staging.vurvey.dev'

jobs:
  sync-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout documentation repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout vurvey-web-manager (for codebase analysis)
        uses: actions/checkout@v4
        with:
          repository: batterii/vurvey-web-manager
          path: vurvey-web-manager
          token: ${{ secrets.VURVEY_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browser
        run: npx puppeteer browsers install chrome

      - name: Capture screenshots
        if: ${{ inputs.skip_screenshots != true }}
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID }}
          HEADLESS: 'true'
        continue-on-error: true
        run: |
          echo "Capturing screenshots from staging environment..."
          npm run update:screenshots || echo "Screenshot capture had errors"

          # Check if screenshots changed
          if git diff --quiet docs/public/screenshots/; then
            echo "SCREENSHOTS_CHANGED=false" >> $GITHUB_ENV
          else
            echo "SCREENSHOTS_CHANGED=true" >> $GITHUB_ENV
            echo "Screenshots have been updated"
          fi

      - name: Run QA tests
        if: ${{ inputs.skip_screenshots != true }}
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID }}
          HEADLESS: 'true'
        run: |
          echo "Running QA test suite..."
          npm run test:qa || echo "QA tests completed with some failures"
        continue-on-error: true

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code CLI installed"

      - name: Run documentation analysis and updates
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running Claude Code analysis..."

          # Read the prompt and pipe to Claude Code
          cat scripts/claude-doc-updater-prompt.md | claude \
            --dangerously-skip-permissions \
            --print \
            --max-turns 50 \
            2>&1 | tee /tmp/claude-log.txt || true

          echo "Claude Code analysis complete"

      - name: Check for documentation changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected"
            git diff --staged --stat
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true' || inputs.force_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Nightly documentation sync"
          title: "[Automated] Nightly Documentation Update"
          body: |
            ## Automated Documentation Update

            This PR was automatically generated by the nightly documentation sync workflow.

            ### Changes Included
            - Updated screenshots (if applicable)
            - Documentation accuracy improvements
            - UI element verification

            ### Verification Checklist
            - [ ] Screenshots are accurate
            - [ ] Documentation matches current UI
            - [ ] All links work correctly
            - [ ] No broken formatting

            ---
            *Generated by GitHub Actions*
          branch: automated/docs-sync
          delete-branch: true
          labels: |
            documentation
            automated

      - name: Collect QA artifacts
        if: always()
        run: |
          mkdir -p /tmp/qa-artifacts
          cp qa-report.json /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-report.json"
          cp qa-failure-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-failure-report.md"
          cp screenshot-validation-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No screenshot-validation-report.md"
          cp -r qa-failure-screenshots /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-failure-screenshots"
          cp /tmp/claude-log.txt /tmp/qa-artifacts/ 2>/dev/null || echo "No claude-log.txt"
          ls -la /tmp/qa-artifacts/

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-analysis
          path: /tmp/qa-artifacts/
          retention-days: 7

  notify-on-failure:
    needs: sync-documentation
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        run: |
          echo "Documentation sync failed. Check the workflow logs for details."
