name: Nightly Documentation Sync

on:
  schedule:
    # Run every night at 3 AM UTC (10 PM EST / 11 PM EDT)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      skip_bug_dispatch:
        description: 'Skip dispatching bug reports to other repos'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22'
  VURVEY_URL: 'https://staging.vurvey.dev'

jobs:
  sync-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    outputs:
      has_bug_reports: ${{ steps.check_bugs.outputs.has_bugs }}
      bug_reports: ${{ steps.check_bugs.outputs.bug_reports }}
      has_doc_fixes: ${{ steps.check_bugs.outputs.has_doc_fixes }}
      doc_fixes: ${{ steps.check_bugs.outputs.doc_fixes }}
      qa_failure_count: ${{ steps.analyze_qa.outputs.failure_count }}

    steps:
      - name: Checkout documentation repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout vurvey-web-manager (for frontend codebase analysis)
        uses: actions/checkout@v4
        with:
          repository: batterii/vurvey-web-manager
          path: vurvey-web-manager
          token: ${{ secrets.VURVEY_REPO_TOKEN }}

      - name: Checkout vurvey-api (for backend codebase analysis)
        uses: actions/checkout@v4
        with:
          repository: batterii/vurvey-api
          path: vurvey-api
          token: ${{ secrets.VURVEY_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browser
        run: npx puppeteer browsers install chrome

      - name: Capture screenshots
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID || '07e5edb5-e739-4a35-9f82-cc6cec7c0193' }}
          HEADLESS: 'true'
          CAPTURE_STRICT: 'false'
        continue-on-error: true
        run: |
          echo "Capturing screenshots from staging environment..."
          npm run update:screenshots || echo "Screenshot capture had errors"

          # Check if screenshots changed
          if git diff --quiet docs/public/screenshots/; then
            echo "SCREENSHOTS_CHANGED=false" >> $GITHUB_ENV
          else
            echo "SCREENSHOTS_CHANGED=true" >> $GITHUB_ENV
            echo "Screenshots have been updated"
          fi

      - name: Run QA tests
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID || '07e5edb5-e739-4a35-9f82-cc6cec7c0193' }}
          HEADLESS: 'true'
          QA_DEEP: 'true'
          QA_WEB_MANAGER_DIR: 'vurvey-web-manager'
          QA_API_DIR: 'vurvey-api'
        run: |
          echo "Running QA test suite..."
          npm run test:qa -- --deep || echo "QA tests completed with some failures"
        continue-on-error: true

      - name: Run web-manager Playwright smoke tests
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          QA_WEB_MANAGER_DIR: 'vurvey-web-manager'
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Running web-manager Playwright smoke tests..."
          npm run test:qa:web-manager-playwright || echo "web-manager Playwright smoke tests completed with some failures"
        continue-on-error: true

      - name: Analyze QA failures
        id: analyze_qa
        continue-on-error: true
        run: |
          echo "Analyzing QA test failures..."
          node scripts/qa-failure-analyzer.js || echo "QA failure analysis completed with errors"

          # Check if failures were found
          if [ -f "qa-output/qa-analysis-input.json" ]; then
            TOTAL_FAILURES=$(cat qa-output/qa-analysis-input.json | jq '.total_failures // 0')
            echo "QA_TOTAL_FAILURES=$TOTAL_FAILURES" >> $GITHUB_ENV
            echo "failure_count=$TOTAL_FAILURES" >> $GITHUB_OUTPUT
            echo "Found $TOTAL_FAILURES classified failure(s)"
          else
            echo "QA_TOTAL_FAILURES=0" >> $GITHUB_ENV
            echo "failure_count=0" >> $GITHUB_OUTPUT
            echo "No QA analysis output found"
          fi

      - name: Lint docs (links + screenshots)
        run: npm run test:docs

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code CLI installed"

      - name: Create output directories
        run: mkdir -p bug-reports doc-fixes

      - name: Run documentation analysis and updates
        timeout-minutes: 30
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running Claude Code analysis..."

          # Build enhanced prompt with QA context
          PROMPT_CONTENT=$(cat scripts/claude-doc-updater-prompt.md)

          # Append QA failure context if available
          if [ "$QA_TOTAL_FAILURES" -gt 0 ] && [ -f "qa-output/qa-analysis-input.json" ]; then
            QA_CONTEXT=$(cat qa-output/qa-analysis-input.json)
            PROMPT_CONTENT="$PROMPT_CONTENT

          ---

          ## ADDITIONAL CONTEXT: QA Test Failures

          The following QA test failures were detected and classified by the automated analyzer.
          Review these failures and incorporate them into your documentation analysis.
          If a failure is classified as DOC_ISSUE, prioritize fixing the corresponding documentation.
          If a failure is classified as CODE_BUG, create a bug report.

          \`\`\`json
          $QA_CONTEXT
          \`\`\`"
          fi

          claude -p "$PROMPT_CONTENT" \
            --model claude-sonnet-4-5-20250929 \
            --dangerously-skip-permissions \
            --max-turns 30 \
            --output-format json \
            2>&1 | tee /tmp/claude-log.txt || true

          echo "Claude Code analysis complete"

      - name: Run QA failure remediation
        if: env.QA_TOTAL_FAILURES != '0'
        timeout-minutes: 20
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running QA failure remediation..."

          REMEDIATION_PROMPT=$(cat scripts/qa-remediation-prompt.md)

          claude -p "$REMEDIATION_PROMPT" \
            --model claude-sonnet-4-5-20250929 \
            --dangerously-skip-permissions \
            --max-turns 20 \
            --output-format json \
            2>&1 | tee /tmp/claude-remediation-log.txt || true

          echo "QA remediation complete"

      - name: Validate documentation accuracy
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID || '07e5edb5-e739-4a35-9f82-cc6cec7c0193' }}
          HEADLESS: 'true'
        continue-on-error: true
        run: node scripts/qa-doc-validator.js

      - name: Check for bug reports and doc fixes
        id: check_bugs
        run: |
          # Check bug reports - collect valid JSON files into an array
          if [ -d "bug-reports" ] && ls bug-reports/*.json >/dev/null 2>&1; then
            BUG_REPORTS=$(jq -s '.' bug-reports/*.json 2>/dev/null || echo '[]')
            BUG_COUNT=$(echo "$BUG_REPORTS" | jq 'length')

            if [ "$BUG_COUNT" -gt 0 ]; then
              echo "has_bugs=true" >> $GITHUB_OUTPUT
              echo "bug_reports<<EOF" >> $GITHUB_OUTPUT
              echo "$BUG_REPORTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "Found $BUG_COUNT bug report(s)"
            else
              echo "has_bugs=false" >> $GITHUB_OUTPUT
              echo "bug_reports=[]" >> $GITHUB_OUTPUT
              echo "Bug report files found but contained no valid entries"
            fi
          else
            echo "has_bugs=false" >> $GITHUB_OUTPUT
            echo "bug_reports=[]" >> $GITHUB_OUTPUT
            echo "No bug reports found"
          fi

          # Check doc fixes - collect valid JSON files into an array
          if [ -d "doc-fixes" ] && ls doc-fixes/*.json >/dev/null 2>&1; then
            DOC_FIXES=$(jq -s '.' doc-fixes/*.json 2>/dev/null || echo '[]')
            FIX_COUNT=$(echo "$DOC_FIXES" | jq 'length')

            if [ "$FIX_COUNT" -gt 0 ]; then
              echo "has_doc_fixes=true" >> $GITHUB_OUTPUT
              echo "doc_fixes<<EOF" >> $GITHUB_OUTPUT
              echo "$DOC_FIXES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "Found $FIX_COUNT doc fix report(s)"
            else
              echo "has_doc_fixes=false" >> $GITHUB_OUTPUT
              echo "doc_fixes=[]" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_doc_fixes=false" >> $GITHUB_OUTPUT
            echo "doc_fixes=[]" >> $GITHUB_OUTPUT
          fi

      - name: Check for documentation changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected"
            git diff --staged --stat
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true' || inputs.force_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Nightly documentation sync"
          title: "[Automated] Nightly Documentation Update"
          body: |
            ## Automated Documentation Update

            This PR was automatically generated by the nightly documentation sync workflow.

            ### Changes Included
            - Updated screenshots (if applicable)
            - Documentation accuracy improvements based on codebase analysis
            - Fixed discrepancies between docs and implementation
            - QA-driven documentation fixes (if applicable)

            ### QA Test Results
            ${{ env.QA_TOTAL_FAILURES > 0 && format('**{0} QA test failure(s) analyzed and remediated.**', env.QA_TOTAL_FAILURES) || 'All QA tests passed.' }}

            ### Bug Reports Generated
            ${{ steps.check_bugs.outputs.has_bugs == 'true' && 'Code bugs were detected and dispatched to target repositories for fixing.' || 'No code bugs detected.' }}

            ### Doc Fixes Generated
            ${{ steps.check_bugs.outputs.has_doc_fixes == 'true' && 'Documentation fix reports were generated for additional review.' || 'No additional doc fixes needed.' }}

            ### Verification Checklist
            - [ ] Documentation changes are accurate
            - [ ] Screenshots match current UI
            - [ ] All links work correctly
            - [ ] No broken formatting

            ---
            *Generated by GitHub Actions*
          branch: automated/docs-sync
          delete-branch: true
          labels: |
            documentation
            automated

      - name: Collect QA artifacts
        if: always()
        run: |
          mkdir -p /tmp/qa-artifacts
          cp -r qa-output /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-output"
          cp screenshot-validation-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No screenshot-validation-report.md"
          cp DOCUMENTATION_AUDIT_SUMMARY.md /tmp/qa-artifacts/ 2>/dev/null || echo "No DOCUMENTATION_AUDIT_SUMMARY.md"
          cp -r qa-failure-screenshots /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-failure-screenshots"
          cp -r bug-reports /tmp/qa-artifacts/ 2>/dev/null || echo "No bug-reports"
          cp -r doc-fixes /tmp/qa-artifacts/ 2>/dev/null || echo "No doc-fixes"
          cp /tmp/claude-log.txt /tmp/qa-artifacts/ 2>/dev/null || echo "No claude-log.txt"
          cp /tmp/claude-remediation-log.txt /tmp/qa-artifacts/ 2>/dev/null || echo "No remediation log"
          cp REMEDIATION_SUMMARY.md /tmp/qa-artifacts/ 2>/dev/null || echo "No REMEDIATION_SUMMARY.md"
          cp qa-output/qa-analysis-input.json /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-analysis-input.json"
          cp qa-output/qa-failure-analysis.md /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-failure-analysis.md"
          cp qa-output/test-fixes-needed.md /tmp/qa-artifacts/ 2>/dev/null || echo "No test-fixes-needed.md"
          cp -r vurvey-web-manager/test-results /tmp/qa-artifacts/ 2>/dev/null || echo "No web-manager test-results"
          cp -r vurvey-web-manager/playwright-report /tmp/qa-artifacts/ 2>/dev/null || echo "No web-manager playwright-report"
          ls -laR /tmp/qa-artifacts/

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-analysis
          path: /tmp/qa-artifacts/
          retention-days: 7

  # Dispatch bug reports to vurvey-web-manager
  dispatch-frontend-bugs:
    needs: sync-documentation
    if: needs.sync-documentation.outputs.has_bug_reports == 'true' && inputs.skip_bug_dispatch != true
    runs-on: ubuntu-latest

    steps:
      - name: Filter frontend bug reports
        id: filter_bugs
        env:
          BUG_REPORTS: ${{ needs.sync-documentation.outputs.bug_reports }}
        run: |
          FRONTEND_BUGS=$(echo "$BUG_REPORTS" | jq -c '[.[] | select(.target_repo == "vurvey-web-manager")]')
          BUG_COUNT=$(echo "$FRONTEND_BUGS" | jq 'length')

          if [ "$BUG_COUNT" -gt "0" ]; then
            echo "has_frontend_bugs=true" >> $GITHUB_OUTPUT
            echo "frontend_bugs<<EOF" >> $GITHUB_OUTPUT
            echo "$FRONTEND_BUGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found $BUG_COUNT frontend bug report(s)"
          else
            echo "has_frontend_bugs=false" >> $GITHUB_OUTPUT
            echo "No frontend bugs to dispatch"
          fi

      - name: Dispatch to vurvey-web-manager
        if: steps.filter_bugs.outputs.has_frontend_bugs == 'true'
        env:
          FRONTEND_BUGS: ${{ steps.filter_bugs.outputs.frontend_bugs }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VURVEY_REPO_TOKEN }}
          repository: batterii/vurvey-web-manager
          event-type: bug-fix-request
          client-payload: >-
            {"source":"vurvey-docs-site","workflow_run_id":"${{ github.run_id }}","bug_reports":${{ steps.filter_bugs.outputs.frontend_bugs }}}

  # Dispatch bug reports to vurvey-api
  dispatch-backend-bugs:
    needs: sync-documentation
    if: needs.sync-documentation.outputs.has_bug_reports == 'true' && inputs.skip_bug_dispatch != true
    runs-on: ubuntu-latest

    steps:
      - name: Filter backend bug reports
        id: filter_bugs
        env:
          BUG_REPORTS: ${{ needs.sync-documentation.outputs.bug_reports }}
        run: |
          BACKEND_BUGS=$(echo "$BUG_REPORTS" | jq -c '[.[] | select(.target_repo == "vurvey-api")]')
          BUG_COUNT=$(echo "$BACKEND_BUGS" | jq 'length')

          if [ "$BUG_COUNT" -gt "0" ]; then
            echo "has_backend_bugs=true" >> $GITHUB_OUTPUT
            echo "backend_bugs<<EOF" >> $GITHUB_OUTPUT
            echo "$BACKEND_BUGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found $BUG_COUNT backend bug report(s)"
          else
            echo "has_backend_bugs=false" >> $GITHUB_OUTPUT
            echo "No backend bugs to dispatch"
          fi

      - name: Dispatch to vurvey-api
        if: steps.filter_bugs.outputs.has_backend_bugs == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VURVEY_REPO_TOKEN }}
          repository: batterii/vurvey-api
          event-type: bug-fix-request
          client-payload: >-
            {"source":"vurvey-docs-site","workflow_run_id":"${{ github.run_id }}","bug_reports":${{ steps.filter_bugs.outputs.backend_bugs }}}

  # Dispatch doc fixes back to vurvey-docs itself via claude-doc-fix workflow
  dispatch-doc-fixes:
    needs: sync-documentation
    if: needs.sync-documentation.outputs.has_doc_fixes == 'true' && inputs.skip_bug_dispatch != true
    runs-on: ubuntu-latest

    steps:
      - name: Dispatch doc-fix-request
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: doc-fix-request
          client-payload: >-
            {"source":"nightly-docs-sync","workflow_run_id":"${{ github.run_id }}","doc_fixes":${{ needs.sync-documentation.outputs.doc_fixes }}}

  notify-on-failure:
    needs: [sync-documentation, dispatch-frontend-bugs, dispatch-backend-bugs, dispatch-doc-fixes]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        run: |
          echo "::error::Nightly documentation sync workflow failed."
          echo ""
          echo "Job statuses:"
          echo "  sync-documentation:     ${{ needs.sync-documentation.result }}"
          echo "  dispatch-frontend-bugs: ${{ needs.dispatch-frontend-bugs.result }}"
          echo "  dispatch-backend-bugs:  ${{ needs.dispatch-backend-bugs.result }}"
          echo "  dispatch-doc-fixes:     ${{ needs.dispatch-doc-fixes.result }}"
          echo ""
          echo "QA failures found: ${{ needs.sync-documentation.outputs.qa_failure_count || '0' }}"
          echo "Bug reports: ${{ needs.sync-documentation.outputs.has_bug_reports }}"
          echo "Doc fixes: ${{ needs.sync-documentation.outputs.has_doc_fixes }}"
          echo ""
          echo "Check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
