name: Nightly Documentation Sync

on:
  schedule:
    # Run every night at 3 AM UTC (10 PM EST / 11 PM EDT)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      skip_screenshots:
        description: 'Skip screenshot capture (faster for testing)'
        required: false
        default: 'false'
        type: boolean
      skip_bug_dispatch:
        description: 'Skip dispatching bug reports to other repos'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22'
  VURVEY_URL: 'https://staging.vurvey.dev'

jobs:
  sync-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      has_bug_reports: ${{ steps.check_bugs.outputs.has_bugs }}
      bug_reports: ${{ steps.check_bugs.outputs.bug_reports }}

    steps:
      - name: Checkout documentation repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout vurvey-web-manager (for frontend codebase analysis)
        uses: actions/checkout@v4
        with:
          repository: batterii/vurvey-web-manager
          path: vurvey-web-manager
          token: ${{ secrets.VURVEY_REPO_TOKEN }}

      - name: Checkout vurvey-api (for backend codebase analysis)
        uses: actions/checkout@v4
        with:
          repository: batterii/vurvey-api
          path: vurvey-api
          token: ${{ secrets.VURVEY_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browser
        run: npx puppeteer browsers install chrome

      - name: Capture screenshots
        if: ${{ inputs.skip_screenshots != true }}
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID }}
          HEADLESS: 'true'
          CAPTURE_STRICT: 'true'
        continue-on-error: true
        run: |
          echo "Capturing screenshots from staging environment..."
          npm run update:screenshots || echo "Screenshot capture had errors"

          # Check if screenshots changed
          if git diff --quiet docs/public/screenshots/; then
            echo "SCREENSHOTS_CHANGED=false" >> $GITHUB_ENV
          else
            echo "SCREENSHOTS_CHANGED=true" >> $GITHUB_ENV
            echo "Screenshots have been updated"
          fi

      - name: Run QA tests
        if: ${{ inputs.skip_screenshots != true }}
        env:
          VURVEY_EMAIL: ${{ secrets.VURVEY_EMAIL }}
          VURVEY_PASSWORD: ${{ secrets.VURVEY_PASSWORD }}
          VURVEY_URL: ${{ env.VURVEY_URL }}
          VURVEY_WORKSPACE_ID: ${{ secrets.VURVEY_WORKSPACE_ID }}
          HEADLESS: 'true'
        run: |
          echo "Running QA test suite..."
          npm run test:qa || echo "QA tests completed with some failures"
        continue-on-error: true

      - name: Lint docs (links + screenshots)
        run: npm run test:docs

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code CLI installed"

      - name: Create bug-reports directory
        run: mkdir -p bug-reports

      - name: Run documentation analysis and updates
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running Claude Code analysis..."

          # Read the prompt file and pass via -p flag for non-interactive mode
          PROMPT_CONTENT=$(cat scripts/claude-doc-updater-prompt.md)

          claude -p "$PROMPT_CONTENT" \
            --dangerously-skip-permissions \
            --max-turns 75 \
            --output-format json \
            2>&1 | tee /tmp/claude-log.txt || true

          echo "Claude Code analysis complete"

      - name: Check for bug reports
        id: check_bugs
        run: |
          if [ -d "bug-reports" ] && [ "$(ls -A bug-reports/*.json 2>/dev/null)" ]; then
            echo "has_bugs=true" >> $GITHUB_OUTPUT

            # Collect bug reports into a JSON array
            BUG_REPORTS=$(ls bug-reports/*.json | while read file; do
              cat "$file"
            done | jq -s '.')

            # Escape for GitHub Actions output
            echo "bug_reports<<EOF" >> $GITHUB_OUTPUT
            echo "$BUG_REPORTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "Found $(ls bug-reports/*.json | wc -l) bug report(s)"
            ls -la bug-reports/
          else
            echo "has_bugs=false" >> $GITHUB_OUTPUT
            echo "bug_reports=[]" >> $GITHUB_OUTPUT
            echo "No bug reports found"
          fi

      - name: Check for documentation changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected"
            git diff --staged --stat
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true' || inputs.force_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Nightly documentation sync"
          title: "[Automated] Nightly Documentation Update"
          body: |
            ## Automated Documentation Update

            This PR was automatically generated by the nightly documentation sync workflow.

            ### Changes Included
            - Updated screenshots (if applicable)
            - Documentation accuracy improvements based on codebase analysis
            - Fixed discrepancies between docs and implementation

            ### Bug Reports Generated
            ${{ steps.check_bugs.outputs.has_bugs == 'true' && 'Code bugs were detected and dispatched to target repositories for fixing.' || 'No code bugs detected.' }}

            ### Verification Checklist
            - [ ] Documentation changes are accurate
            - [ ] Screenshots match current UI
            - [ ] All links work correctly
            - [ ] No broken formatting

            ---
            *Generated by GitHub Actions*
          branch: automated/docs-sync
          delete-branch: true
          labels: |
            documentation
            automated

      - name: Collect QA artifacts
        if: always()
        run: |
          mkdir -p /tmp/qa-artifacts
          cp qa-output/qa-report.json /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-output/qa-report.json"
          cp qa-output/qa-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-output/qa-report.md"
          cp qa-output/qa-failure-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-output/qa-failure-report.md"
          cp -r qa-output /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-output"
          cp screenshot-validation-report.md /tmp/qa-artifacts/ 2>/dev/null || echo "No screenshot-validation-report.md"
          cp DOCUMENTATION_AUDIT_SUMMARY.md /tmp/qa-artifacts/ 2>/dev/null || echo "No DOCUMENTATION_AUDIT_SUMMARY.md"
          cp -r qa-failure-screenshots /tmp/qa-artifacts/ 2>/dev/null || echo "No qa-failure-screenshots"
          cp -r bug-reports /tmp/qa-artifacts/ 2>/dev/null || echo "No bug-reports"
          cp /tmp/claude-log.txt /tmp/qa-artifacts/ 2>/dev/null || echo "No claude-log.txt"
          ls -la /tmp/qa-artifacts/

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-analysis
          path: /tmp/qa-artifacts/
          retention-days: 7

  # Dispatch bug reports to vurvey-web-manager
  dispatch-frontend-bugs:
    needs: sync-documentation
    if: needs.sync-documentation.outputs.has_bug_reports == 'true' && inputs.skip_bug_dispatch != true
    runs-on: ubuntu-latest

    steps:
      - name: Filter frontend bug reports
        id: filter_bugs
        run: |
          FRONTEND_BUGS=$(echo '${{ needs.sync-documentation.outputs.bug_reports }}' | jq '[.[] | select(.target_repo == "vurvey-web-manager")]')
          BUG_COUNT=$(echo "$FRONTEND_BUGS" | jq 'length')

          if [ "$BUG_COUNT" -gt "0" ]; then
            echo "has_frontend_bugs=true" >> $GITHUB_OUTPUT
            echo "frontend_bugs<<EOF" >> $GITHUB_OUTPUT
            echo "$FRONTEND_BUGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found $BUG_COUNT frontend bug report(s)"
          else
            echo "has_frontend_bugs=false" >> $GITHUB_OUTPUT
            echo "No frontend bugs to dispatch"
          fi

      - name: Dispatch to vurvey-web-manager
        if: steps.filter_bugs.outputs.has_frontend_bugs == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VURVEY_REPO_TOKEN }}
          repository: batterii/vurvey-web-manager
          event-type: bug-fix-request
          client-payload: |
            {
              "source": "vurvey-docs-site",
              "workflow_run_id": "${{ github.run_id }}",
              "bug_reports": ${{ steps.filter_bugs.outputs.frontend_bugs }}
            }

  # Dispatch bug reports to vurvey-api
  dispatch-backend-bugs:
    needs: sync-documentation
    if: needs.sync-documentation.outputs.has_bug_reports == 'true' && inputs.skip_bug_dispatch != true
    runs-on: ubuntu-latest

    steps:
      - name: Filter backend bug reports
        id: filter_bugs
        run: |
          BACKEND_BUGS=$(echo '${{ needs.sync-documentation.outputs.bug_reports }}' | jq '[.[] | select(.target_repo == "vurvey-api")]')
          BUG_COUNT=$(echo "$BACKEND_BUGS" | jq 'length')

          if [ "$BUG_COUNT" -gt "0" ]; then
            echo "has_backend_bugs=true" >> $GITHUB_OUTPUT
            echo "backend_bugs<<EOF" >> $GITHUB_OUTPUT
            echo "$BACKEND_BUGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found $BUG_COUNT backend bug report(s)"
          else
            echo "has_backend_bugs=false" >> $GITHUB_OUTPUT
            echo "No backend bugs to dispatch"
          fi

      - name: Dispatch to vurvey-api
        if: steps.filter_bugs.outputs.has_backend_bugs == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VURVEY_REPO_TOKEN }}
          repository: batterii/vurvey-api
          event-type: bug-fix-request
          client-payload: |
            {
              "source": "vurvey-docs-site",
              "workflow_run_id": "${{ github.run_id }}",
              "bug_reports": ${{ steps.filter_bugs.outputs.backend_bugs }}
            }

  notify-on-failure:
    needs: [sync-documentation, dispatch-frontend-bugs, dispatch-backend-bugs]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        run: |
          echo "Documentation sync or bug dispatch failed. Check the workflow logs for details."
