name: Bug Fix Result Handler

on:
  repository_dispatch:
    types: [bug-fix-result]

permissions:
  contents: read
  issues: write

env:
  NODE_VERSION: "22"

jobs:
  handle-result:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Extract result
        id: result
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          echo "$PAYLOAD" > /tmp/result-payload.json

          SOURCE_REPO=$(echo "$PAYLOAD" | jq -r '.source_repo // "unknown"')
          BUG_TITLE=$(echo "$PAYLOAD" | jq -r '.bug_title // "Unknown bug"')
          RESULT=$(echo "$PAYLOAD" | jq -r '.result // "unknown"')
          PR_URL=$(echo "$PAYLOAD" | jq -r '.pr_url // ""')
          ISSUE_NUMBER=$(echo "$PAYLOAD" | jq -r '.issue_number // ""')
          ORIGINAL_DOC_REF=$(echo "$PAYLOAD" | jq -r '.original_doc_reference // ""')
          DOC_FILE=$(echo "$PAYLOAD" | jq -r '.doc_file // ""')
          DOC_SECTION=$(echo "$PAYLOAD" | jq -r '.doc_section // ""')
          DOC_UPDATE_NEEDED=$(echo "$PAYLOAD" | jq -r '.doc_update_needed // "false"')
          DOC_CORRECT_TEXT=$(echo "$PAYLOAD" | jq -r '.doc_correct_text // ""')

          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "bug_title=$BUG_TITLE" >> $GITHUB_OUTPUT
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "original_doc_ref=$ORIGINAL_DOC_REF" >> $GITHUB_OUTPUT
          echo "doc_file=$DOC_FILE" >> $GITHUB_OUTPUT
          echo "doc_section=$DOC_SECTION" >> $GITHUB_OUTPUT
          echo "doc_update_needed=$DOC_UPDATE_NEEDED" >> $GITHUB_OUTPUT
          echo "doc_correct_text=$DOC_CORRECT_TEXT" >> $GITHUB_OUTPUT

          echo "Received bug fix result: $RESULT for '$BUG_TITLE' from $SOURCE_REPO"

      - name: Handle fixed result
        if: steps.result.outputs.result == 'fixed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REPO: ${{ steps.result.outputs.source_repo }}
          BUG_TITLE: ${{ steps.result.outputs.bug_title }}
          PR_URL: ${{ steps.result.outputs.pr_url }}
          ISSUE_NUMBER: ${{ steps.result.outputs.issue_number }}
        run: |
          cat << EOF > /tmp/issue-body.md
          ## Bug Fix Completed

          A bug fix has been successfully applied in a sibling repository.

          - **Source repo:** $SOURCE_REPO
          - **Bug:** $BUG_TITLE
          - **PR:** $PR_URL
          - **Original issue:** ${ISSUE_NUMBER:+#$ISSUE_NUMBER}

          This issue is for tracking documentation updates that may be needed as a result of the code fix.

          ---
          *Generated by Bug Fix Result Handler*
          EOF

          gh issue create \
            --title "[Bug Fixed] $BUG_TITLE ($SOURCE_REPO)" \
            --body "$(cat /tmp/issue-body.md)" \
            --label "documentation" \
            --label "bug-fix-tracking"

      - name: Trigger doc update if needed
        if: steps.result.outputs.result == 'fixed' && steps.result.outputs.doc_update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUG_TITLE: ${{ steps.result.outputs.bug_title }}
          DOC_FILE: ${{ steps.result.outputs.doc_file }}
          DOC_SECTION: ${{ steps.result.outputs.doc_section }}
          DOC_CORRECT_TEXT: ${{ steps.result.outputs.doc_correct_text }}
          ORIGINAL_DOC_REF: ${{ steps.result.outputs.original_doc_ref }}
          SOURCE_REPO: ${{ steps.result.outputs.source_repo }}
        run: |
          # Build doc fix payload and dispatch to self
          DOC_FIX=$(jq -n \
            --arg title "Update docs after fix: $BUG_TITLE" \
            --arg description "A code bug was fixed in $SOURCE_REPO. The documentation needs to be updated to reflect the corrected behavior." \
            --arg doc_file "$DOC_FILE" \
            --arg section "$DOC_SECTION" \
            --arg correct_text "$DOC_CORRECT_TEXT" \
            --arg source "bug-fix-result-handler" \
            '{
              title: $title,
              description: $description,
              documentation_file: $doc_file,
              section: $section,
              current_text: "See original doc reference",
              correct_text: $correct_text,
              source: $source
            }')

          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=doc-fix-request \
            --input - << EOF
          {
            "event_type": "doc-fix-request",
            "client_payload": {
              "source": "bug-fix-result-handler",
              "workflow_run_id": "${{ github.run_id }}",
              "doc_fixes": [$DOC_FIX]
            }
          }
          EOF

          echo "Dispatched doc-fix-request for documentation update"

      - name: Handle failed result
        if: steps.result.outputs.result == 'failed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REPO: ${{ steps.result.outputs.source_repo }}
          BUG_TITLE: ${{ steps.result.outputs.bug_title }}
          PR_URL: ${{ steps.result.outputs.pr_url }}
          ISSUE_NUMBER: ${{ steps.result.outputs.issue_number }}
          ORIGINAL_DOC_REF: ${{ steps.result.outputs.original_doc_ref }}
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: |
          cat << EOF > /tmp/escalation-body.md
          ## Escalation: Automated Bug Fix Failed

          The Claude Bug Fix Agent was unable to resolve this bug automatically. Human review is required.

          ### Details

          - **Source repo:** $SOURCE_REPO
          - **Bug:** $BUG_TITLE
          - **Attempted PR:** ${PR_URL:-None}
          - **Original issue:** ${ISSUE_NUMBER:+$SOURCE_REPO#$ISSUE_NUMBER}
          - **Doc reference:** ${ORIGINAL_DOC_REF:-None}

          ### Full Result Payload

          \`\`\`json
          $PAYLOAD
          \`\`\`

          ### Next Steps

          1. Investigate the bug manually in \`$SOURCE_REPO\`
          2. Determine if the documentation accurately describes the expected behavior
          3. If the bug is a documentation error, update the docs instead
          4. If the bug is a code error, fix it manually and update this issue

          ---
          *Generated by Bug Fix Result Handler*
          EOF

          gh issue create \
            --title "[Escalation] Failed fix: $BUG_TITLE ($SOURCE_REPO)" \
            --body "$(cat /tmp/escalation-body.md)" \
            --label "bug" \
            --label "escalation" \
            --label "needs-human-review"

          echo "Created escalation issue for failed bug fix"

      - name: Handle skipped result
        if: steps.result.outputs.result == 'skipped'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REPO: ${{ steps.result.outputs.source_repo }}
          BUG_TITLE: ${{ steps.result.outputs.bug_title }}
        run: |
          echo "Bug fix was skipped for '$BUG_TITLE' in $SOURCE_REPO"
          echo "This typically means a PR or issue already existed."

      - name: Step summary
        if: always()
        env:
          SOURCE_REPO: ${{ steps.result.outputs.source_repo }}
          BUG_TITLE: ${{ steps.result.outputs.bug_title }}
          RESULT: ${{ steps.result.outputs.result }}
          PR_URL: ${{ steps.result.outputs.pr_url }}
        run: |
          echo "## Bug Fix Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** $SOURCE_REPO" >> $GITHUB_STEP_SUMMARY
          echo "- **Bug:** $BUG_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** $RESULT" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PR_URL" ]; then
            echo "- **PR:** $PR_URL" >> $GITHUB_STEP_SUMMARY
          fi
